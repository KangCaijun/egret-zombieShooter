var __reflect=this&&this.__reflect||function(e,t,i){e.__class__=t,i?i.push(t):i=[t],e.__types__=e.__types__?i.concat(e.__types__):i},__extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},__awaiter=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(n,o){function s(e){try{h(r.next(e))}catch(t){o(t)}}function a(e){try{h(r["throw"](e))}catch(t){o(t)}}function h(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(s,a)}h((r=r.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function i(e){return function(t){return r([e,t])}}function r(i){if(n)throw new TypeError("Generator is already executing.");for(;h;)try{if(n=1,o&&(s=o[2&i[0]?"return":i[0]?"throw":"next"])&&!(s=s.call(o,i[1])).done)return s;switch(o=0,s&&(i=[0,s.value]),i[0]){case 0:case 1:s=i;break;case 4:return h.label++,{value:i[1],done:!1};case 5:h.label++,o=i[1],i=[0];continue;case 7:i=h.ops.pop(),h.trys.pop();continue;default:if(s=h.trys,!(s=s.length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){h=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){h.label=i[1];break}if(6===i[0]&&h.label<s[1]){h.label=s[1],s=i;break}if(s&&h.label<s[2]){h.label=s[2],h.ops.push(i);break}s[2]&&h.ops.pop(),h.trys.pop();continue}i=t.call(e,h)}catch(r){i=[6,r],o=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var n,o,s,a,h={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a},AssetAdapter=function(){function e(){}return e.prototype.getAsset=function(e,t,i){function r(r){t.call(i,r,e)}if(RES.hasRes(e)){var n=RES.getRes(e);n?r(n):RES.getResAsync(e,r,this)}else RES.getResByUrl(e,r,this,RES.ResourceItem.TYPE_IMAGE)},e}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var Bullet=function(e){function t(){var t=e.call(this)||this;return t._speed=1500,t._vector=null,t._bullet=new egret.Bitmap(RES.getRes("bullet_95m_png")),t.addChild(t._bullet),t.anchorOffsetX=t.width/2,t}return __extends(t,e),t.prototype.onUpdate=function(e){null!=this._vector&&(this.x+=this._vector.x*this._speed*(e/1e3),this.y+=this._vector.y*this._speed*(e/1e3),this.y<=-this.height&&this.parent&&this.parent.removeChild(this))},t}(egret.Sprite);__reflect(Bullet.prototype,"Bullet");var GameSence=function(e){function t(){var t=e.call(this)||this;t._gameUI=new GameUI,t._lastTimestamp=0,t._brithtime=0,t._guncd=0,t._shot_vector=null;var i=new egret.Bitmap;i.width=Util.getStageWidth(),i.height=Util.getStageHeight(),i.texture=RES.getRes("bg_png"),t.addChild(i),t._zombies_layer=new egret.Sprite,t.addChild(t._zombies_layer),t._bullets_layer=new egret.Sprite,t.addChild(t._bullets_layer),t._gun=new egret.Bitmap(RES.getRes("gun_gatling_1_png")),t._gun.x=Util.getStageWidth()/2,t._gun.y=Util.getStageHeight()-t._gun.height/2,Util.setAnchorCenter(t._gun,0,0),t.addChild(t._gun),t.touchEnabled=!0,t.addEventListener(egret.TouchEvent.TOUCH_BEGIN,t.onTouchBegin,t),t.addEventListener(egret.TouchEvent.TOUCH_MOVE,t.onTouchMove,t),t.addEventListener(egret.TouchEvent.TOUCH_END,t.onTouchEnd,t),egret.startTick(t.onUpdate,t),t.addChild(t._gameUI);var r=RES.getRes("music_gaming_mp3"),n=r.play(0,0);return n.volume=.3,t._gunsound=RES.getRes("machine_gun_mp3"),t}return __extends(t,e),t.getInstance=function(){return null==t._instance&&(t._instance=new t),t._instance},t.prototype.onUpdate=function(e){var t=e-this._lastTimestamp;if(this._lastTimestamp=e,this._gameUI.Time-=t,this._brithtime+=t,this._brithtime>=500){this._brithtime=0;var i=void 0;i=Math.random()<.3?new Zombie1:new Zombie,i.x=i.width+Math.random()*(Util.getStageWidth()-i.width),i.y=-i.height,this._zombies_layer.addChild(i)}for(var r=this._zombies_layer.numChildren-1;r>=0;r--){var i=this._zombies_layer.getChildAt(r);i.onUpdate(t),null==i.parent&&(this._gameUI.Time-=1e3)}if(this._gameUI.Time<=0)return this._zombies_layer.removeChildren(),void this._bullets_layer.removeChildren();null!=this._shot_vector&&(this._guncd+=t,this._guncd>=150&&(this._guncd=0,this.addBullet()));for(var r=this._bullets_layer.numChildren-1;r>=0;r--){var n=this._bullets_layer.getChildAt(r);n.onUpdate(t);for(var o=new egret.Point(n.x,n.y),s=0,a=this._zombies_layer.numChildren;a>s;s++){var i=this._zombies_layer.getChildAt(s);if(i.zombieState!=ZombieState.Dead&&i.getBlock().containsPoint(o)){i.HP-=1,i.HP<=0&&(this._gameUI.addSocreEffect(i.x,i.y,i.Score),this._gameUI.addHurtEffect(i.x,i.y),i.dead()),this._bullets_layer.removeChild(n);break}}}return!1},t.prototype.onTouchBegin=function(e){var t=e.stageX-this._gun.x,i=e.stageY-this._gun.y;this._gun.rotation=180*Math.atan2(i,t)/Math.PI+90,this._shot_vector=new egret.Point(t,i),this._shot_vector.normalize(1)},t.prototype.onTouchMove=function(e){var t=e.stageX-this._gun.x,i=e.stageY-this._gun.y;this._gun.rotation=180*Math.atan2(i,t)/Math.PI+90,this._shot_vector=new egret.Point(t,i),this._shot_vector.normalize(1)},t.prototype.onTouchEnd=function(e){this._shot_vector=null},t.prototype.addBullet=function(){this._gunsound.play(0,1);var e=new Bullet;e._vector=this._shot_vector,e.rotation=180*Math.atan2(this._shot_vector.y,this._shot_vector.x)/Math.PI+90,e.x=this._gun.x-10,e.y=this._gun.y,this._bullets_layer.addChild(e)},t.prototype.beginGame=function(){this._gameUI.onClickReplay()},t}(egret.DisplayObjectContainer);__reflect(GameSence.prototype,"GameSence");var GameUI=function(e){function t(){var t=e.call(this)||this;return t.mcFactory=null,t.skinName="src/GameUISkin.exml",t.width=Util.getStageWidth(),t.height=Util.getStageHeight(),t.btn_replay.addEventListener(egret.TouchEvent.TOUCH_TAP,t.onClickReplay,t),t.onClickReplay(),t.Time=0,t}return __extends(t,e),t.prototype.onClickReplay=function(){this.group_over.visible=!1,this.Score=0,this.Time=3e4},Object.defineProperty(t.prototype,"Score",{get:function(){return parseInt(this.lb_score.text)},set:function(e){this.lb_score.text=e.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Time",{get:function(){return this._time},set:function(e){this._time=e,this._time<=0&&(this._time=0,this.ShowOver());var t=Math.floor(this._time/1e3),i=this._time%1e3;this.lb_time.text=t+"."+i},enumerable:!0,configurable:!0}),t.prototype.ShowOver=function(){this.group_over.visible=!0,this.lb_over_score.text=this.Score.toString(),this.Score>this.getBestScore()&&this.setBestScore(this.Score),this.setBestScore(this.Score),this.lb_best_score.text=this.getBestScore().toString()},t.prototype.getBestScore=function(){var e=egret.localStorage.getItem("best_score");return null==e?0:parseInt(e)},t.prototype.setBestScore=function(e){egret.localStorage.setItem("best_score",e.toString())},t.prototype.addSocreEffect=function(e,t,i){var r=new eui.Label;r.text=i.toString(),r.x=e,r.y=t,r.stroke=3,this.group_effect.addChild(r);var n=this.lb_score.x+this.lb_score.width,o=this.lb_score.y;egret.Tween.get(r).to({x:n,y:o},500,egret.Ease.circInOut).call(this.addScore,this,[i]).call(this.removeEffectFromGroup,this,[r])},t.prototype.addScore=function(e){this.Score+=e},t.prototype.removeEffectFromGroup=function(e){this.group_effect.removeChild(e)},t.prototype.addHurtEffect=function(e,t){null==this.mcFactory&&(this.mcFactory=new egret.MovieClipDataFactory(RES.getRes("hurteffect_json"),RES.getRes("hurteffect_png")));var i=new egret.MovieClip(this.mcFactory.generateMovieClipData("eff_hurt_0"));i.x=e,i.y=t,i.gotoAndPlay("play",1),this.group_effect.addChild(i),egret.Tween.get(this).wait(200).call(this.removeEffectFromGroup,this,[i])},t}(eui.Component);__reflect(GameUI.prototype,"GameUI");var LoadingUI=function(e){function t(){var t=e.call(this)||this;return t.createView(),t}return __extends(t,e),t.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},t.prototype.onProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.createChildren=function(){e.prototype.createChildren.call(this),egret.lifecycle.addLifecycleListener(function(e){}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()};var t=new AssetAdapter;egret.registerImplementation("eui.IAssetAdapter",t),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.runGame()["catch"](function(e){console.log(e)})},t.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.loadResource()];case 1:return e.sent(),this.createGameScene(),[2]}})})},t.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var e,t;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,4,,5]),e=new LoadingUI,this.stage.addChild(e),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return i.sent(),[4,this.loadTheme()];case 2:return i.sent(),[4,RES.loadGroup("preload",0,e)];case 3:return i.sent(),this.stage.removeChild(e),[3,5];case 4:return t=i.sent(),console.error(t),[3,5];case 5:return[2]}})})},t.prototype.loadTheme=function(){var e=this;return new Promise(function(t,i){var r=new eui.Theme("resource/default.thm.json",e.stage);r.addEventListener(eui.UIEvent.COMPLETE,function(){t()},e)})},t.prototype.createGameScene=function(){this.stage.setContentSize(Util.getStageWidth(),Util.getStageHeight()),this.addChild(new StartUI)},t}(eui.UILayer);__reflect(Main.prototype,"Main");var StartUI=function(e){function t(){var t=e.call(this)||this;return t.skinName="src/StartUISkin.exml",t.width=Util.getStageWidth(),t.height=Util.getStageHeight(),t.btn_start.touchEnabled=!0,t.btn_start.addEventListener(egret.TouchEvent.TOUCH_TAP,t.onStart,t),t}return __extends(t,e),t.prototype.onStart=function(){this.parent.addChild(GameSence.getInstance()),GameSence.getInstance().beginGame(),this.parent.removeChild(this)},t}(eui.Component);__reflect(StartUI.prototype,"StartUI");var ThemeAdapter=function(){function e(){}return e.prototype.getTheme=function(e,t,i,r){function n(e){t.call(r,e)}function o(t){t.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),i.call(r))}var s=this;"undefined"!=typeof generateEUI?egret.callLater(function(){t.call(r,generateEUI)},this):"undefined"!=typeof generateEUI2?RES.getResByUrl("resource/gameEui.json",function(e,i){window.JSONParseClass.setData(e),n(e),egret.callLater(function(){t.call(r,generateEUI2)},s)},this,RES.ResourceItem.TYPE_JSON):(RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),RES.getResByUrl(e,n,this,RES.ResourceItem.TYPE_TEXT))},e}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var Util=function(){function e(){}return e.getStageWidth=function(){return egret.MainContext.instance.stage.stageWidth},e.getStageHeight=function(){return egret.MainContext.instance.stage.stageHeight},e.centerPoint=function(e,t,i,r){var n=t||0,o=i||0,s=r?0:e.width,a=r?0:e.height;e.x=(this.getStageWidth()-s)/2-n,e.y=(this.getStageHeight()-a)/2-o},e.setAnchorCenter=function(e,t,i){var r=t||0,n=i||0;e.anchorOffsetX=e.width/2-r,e.anchorOffsetY=e.height/2-n},e.hitTest=function(e,t){if(void 0==e)return!1;if(void 0==t)return!1;var i=e.getBounds(),r=t.getBounds();return i.x=e.x,i.y=e.y,r.x=t.x,r.y=t.y,i.intersects(r)},e}();__reflect(Util.prototype,"Util");var Zombie=function(e){function t(){var t=e.call(this)||this;t._speed=250,t._framesindex=0,t._frametimer=0,t._frames=[],t._frames_die=[],t.zombieState=ZombieState.Run,t.HP=2,t.Score=100,t._zombie=new egret.Bitmap(RES.getRes("enemy_05_walk_front_00_png")),t.addChild(t._zombie),t.initZombie();for(var i=0;6>i;i++)t._frames_die.push(RES.getRes("enemy_dead_01_0"+i+"_png"));return t}return __extends(t,e),t.prototype.initZombie=function(){for(var e=0;7>e;e++)this._frames.push(RES.getRes("enemy_05_walk_front_0"+e+"_png"))},t.prototype.onUpdate=function(e){this.zombieState==ZombieState.Run&&(this.y+=this._speed*(e/1e3)),this.y>=Util.getStageHeight()-50&&this.parent.removeChild(this),this._frametimer+=e,this._frametimer>60&&(this._frametimer=0,this.zombieState==ZombieState.Run?(this._zombie.texture=this._frames[this._framesindex],this._framesindex<this._frames.length-1?this._framesindex++:this._framesindex=0):(this._framesindex<this._frames_die.length&&(this._zombie.texture=this._frames_die[this._framesindex],this._framesindex++),this.alpha<=0?this.parent.removeChild(this):this.alpha-=.05))},t.prototype.dead=function(){this.zombieState=ZombieState.Dead,this._framesindex=0},t.prototype.getBlock=function(){return new egret.Rectangle(this.x+10,this.y+10,this.width-10,this.height-10)},t}(egret.Sprite);__reflect(Zombie.prototype,"Zombie");var ZombieState;!function(e){e[e.Run=0]="Run",e[e.Dead=1]="Dead"}(ZombieState||(ZombieState={}));var Zombie1=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.initZombie=function(){this.HP=4,this.Score=400,this._speed=300;for(var e=0;7>e;e++)this._frames.push(RES.getRes("enemy_08_walk_front_0"+e+"_png"))},t}(Zombie);__reflect(Zombie1.prototype,"Zombie1");